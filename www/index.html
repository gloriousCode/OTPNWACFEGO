<!doctype html>
<html>

<head>
    <script src="/js/jquery-3.4.1.min.js"></script>
    <script src="/js/materialize.min.js"></script>
    <title>OTPNWACFEGO</title>
    <link rel="shortcut icon" href="favicon.png">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/materialize.min.css">
</head>

<body>
    <div class="decrypt-prompt">
        <input id="decrypt-key" />
        <div id="decrypt-key-btn" class="btn btn-decr">DECRYPT</div>
    </div>
    <div class="encrypt-prompt">
        Would you like to encrypt your data.json?
        <input id="encrypt-key" />
        <div id="encrypt-key-btn" class="btn btn-decr">ENCRYPT</div>
        <div id="encrypt-no-btn" class="btn btn-decr">No thanks</div>
    </div>

    <div class="otp-codes"></div>
    <script>
        $(document).ready(function() {
            var isLoaded = false
            var prompt = false

            document.querySelector('#decrypt-key-btn').addEventListener('click', async() => {
                setKey();
            });
            document.querySelector('#encrypt-no-btn').addEventListener('click', async() => {
                $(".encrypt-prompt").hide();
                console.log(await dontEncrypt());
            });
            // We use async/await because Go functions are asynchronous
            const render = async() => {
                isLoaded = await isConfigLoaded();
                if (!isLoaded) {
                    $(".decrypt-prompt").show();
                    $(".otp-codes").hide();
                    return
                } else {
                    $(".decrypt-prompt").hide();
                    $(".otp-codes").show();
                }
                prompt = await shouldPromptEncrypt();
                if (prompt) {
                    $(".encrypt-prompt").show();
                } else {
                    $(".encrypt-prompt").hide();
                }

                var codes = await getCodes();
                var first = true
                $.each(codes, function(index, value) {
                    outputDivs(codes[index][0], codes[index][1], codes[index][2], first)
                    first = false
                });
            };

            function outputDivs(name, code, counter, first) {
                var remainingClass = "remaining"
                if (counter == "5s" ||
                    counter == "4s" ||
                    counter == "3s" ||
                    counter == "2s" ||
                    counter == "1s" ||
                    counter == "0s") {
                    remainingClass = "urgent"
                }
                var html = `
                <div class="counter-container">
                    <h4 class="` + remainingClass + `">` + name + ` - ` + counter + `</h4>
                    <div class="btn-row">
                        <input type="text" class="counter" value="` + code + `" id="` + name + `">
                        <div id="` + name + `-btn" class="btn btn-decr">COPY</div>
                    </div>
                </div>
                `
                if (first == true) {
                    $(".otp-codes").html(html)
                } else {
                    $(".otp-codes").append(html)
                }

                $("#" + name + "-btn").click(function() {
                    var copyText = document.getElementById(name);
                    copyText.select();
                    copyText.setSelectionRange(0, 99999); /*For mobile devices*/
                    document.execCommand("copy");
                });
            }
            render();
            setInterval(function() {
                render();
            }, 1000);
        })
    </script>
</body>

</html>